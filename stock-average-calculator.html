<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculate stock average price for multiple purchases. Stock averaging calculator with breakeven analysis and profit/loss projections.">
    <title>Stock Average Calculator - Stock Averaging Down Calculator | Skrollmates</title>
    <link rel="canonical" href="https://skrollmates.com/stock-average-calculator.html">
    <meta property="og:title" content="Stock Average Calculator - Stock Averaging Down Calculator">
    <meta property="og:description" content="Calculate average stock price and analyze averaging down strategies with profit/loss projections.">
    <meta property="og:url" content="https://skrollmates.com/stock-average-calculator.html">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://skrollmates.com/skrollmates-512.webp">
    <meta property="og:image:width" content="512">
    <meta property="og:image:height" content="512">
    <meta property="og:site_name" content="Skrollmates">
    <meta property="og:locale" content="en_IN">
    <meta property="og:image:alt" content="Skrollmates logo">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@skrollmates">
    <meta name="robots" content="index, follow">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="menu.css">
    <link rel="stylesheet" href="mobile-responsive.css">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Stock Average Calculator",
        "description": "Calculate average stock price and breakeven analysis for multiple stock purchases",
        "url": "https://skrollmates.com/stock-average-calculator.html",
        "applicationCategory": "FinanceApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "INR"
        }
    }
    </script>
    <style>
        .calculator-container {
            max-width: 1200px;
            margin: 100px auto 40px;
            padding: 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
        }
        
        .input-group {
            margin-bottom: 25px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #2e7d32;
        }
        
        .transaction-entry {
            border: 2px solid #e8f5e8;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fffe;
            position: relative;
        }
        
        .transaction-entry.negative {
            border-color: #ffcdd2;
            background: #fdf2f2;
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .transaction-number {
            font-weight: 600;
            color: #2e7d32;
            font-size: 18px;
        }
        
        .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .transaction-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .results-panel {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            height: fit-content;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .result-item.highlight {
            background: rgba(255,255,255,0.1);
            margin: 10px -15px;
            padding: 15px;
            border-radius: 6px;
            border-bottom: none;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            height: 300px;
        }
        
        .transactions-table {
            background: white;
            border-radius: 8px;
            margin-top: 20px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .transactions-table h4 {
            background: #2e7d32;
            color: white;
            margin: 0;
            padding: 15px;
        }
        
        .table-body {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .trans-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .trans-table th, .trans-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .trans-table th {
            background: #f5f5f5;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .trans-table .amount {
            text-align: right;
        }
        
        .analysis-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .analysis-panel h4 {
            margin-top: 0;
            color: #2e7d32;
            border-bottom: 2px solid #e8f5e8;
            padding-bottom: 10px;
        }
        
        .breakeven-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        
        .breakeven-item {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #4caf50;
        }
        
        .breakeven-item.negative {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .breakeven-value {
            font-size: 24px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 5px;
        }
        
        .breakeven-value.negative {
            color: #d32f2f;
        }
        
        .breakeven-label {
            font-size: 14px;
            color: #666;
        }
        
        .scenario-analysis {
            margin-top: 20px;
        }
        
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .scenario-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .scenario-price {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .scenario-pl {
            font-size: 16px;
            font-weight: 600;
        }
        
        .scenario-pl.profit { color: #4caf50; }
        .scenario-pl.loss { color: #f44336; }
        
        .print-btn, .calc-btn, .add-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        
        .calc-btn {
            background: #2e7d32;
            color: white;
        }
        
        .add-btn {
            background: #1976d2;
            color: white;
        }
        
        .print-btn {
            background: #666;
            color: white;
        }
        
        .calc-btn:hover { background: #1b5e20; }
        .add-btn:hover { background: #1565c0; }
        .print-btn:hover { background: #555; }
        
        .strategy-tips {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #ff9800;
        }
        
        .strategy-tips h4 {
            margin-top: 0;
            color: #e65100;
        }
        
        .strategy-tips ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .strategy-tips li {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .calc-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .transaction-grid {
                grid-template-columns: 1fr;
            }
            
            .breakeven-info {
                grid-template-columns: 1fr;
            }
            
            .scenario-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .calculator-container {
                margin-top: 90px;
                padding: 15px;
            }
            
            .input-group {
                margin-bottom: 20px;
            }
            
            .input-field {
                padding: 14px 12px;
                font-size: 16px;
                box-sizing: border-box;
            }
            
            .input-label {
                margin-bottom: 6px;
                font-size: 14px;
            }
            
            .purchase-row {
                gap: 10px;
            }
            
            .purchase-row input {
                min-width: 80px;
            }
        }
        
        @media print {
            .navbar, .print-btn, .calc-btn, .add-btn, .remove-btn { display: none; }
            .calculator-container { margin: 0; box-shadow: none; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="brand">
            <img src="skrollmates.webp" alt="Skrollmates logo">
            <span class="brand-name">Skrollmates</span>
        </div>
        <span class="menu-toggle" aria-label="Toggle menu" id="menuToggle" tabindex="1">&#9776;</span>
        <ul id="mainMenu">
            <li><a href="index.html">Home</a></li>
            <li><a href="whatsapp-extension.html">WhatsApp Extension</a></li>
            <li class="menu-dropdown">
                <a href="javascript:void(0)" class="menu-dropdown-toggle" onclick="return false;">EMI Calculators <span class="dropdown-arrow">â–¼</span></a>
                <ul class="menu-submenu">
                    <li><a href="emi-calculator.html">General EMI Calculator</a></li>
                    <li><a href="home-loan.html">Home Loan EMI</a></li>
                    <li><a href="personal-loan.html">Personal Loan EMI</a></li>
                    <li><a href="car-loan.html">Car Loan EMI</a></li>
                    <li><a href="two-wheeler-loan.html">Two Wheeler Loan EMI</a></li>
                    <li><a href="lap-loan.html">LAP Loan EMI</a></li>
                </ul>
            </li>
            <li class="menu-dropdown">
                <a href="javascript:void(0)" class="menu-dropdown-toggle" onclick="return false;">Investment Calculators <span class="dropdown-arrow">â–¼</span></a>
                <ul class="menu-submenu">
                    <li><a href="sip-calculator.html">SIP Calculator</a></li>
                    <li><a href="lumpsum-calculator.html">Lumpsum Calculator</a></li>
                    <li><a href="step-up-sip-calculator.html">Step-Up SIP Calculator</a></li>
                    <li><a href="swp-calculator.html">SWP Calculator</a></li>
                    <li><a href="mf-calculator.html">Mutual Fund Calculator</a></li>
                </ul>
            </li>
            <li class="menu-dropdown">
                <a href="javascript:void(0)" class="menu-dropdown-toggle" onclick="return false;">Savings Calculators <span class="dropdown-arrow">â–¼</span></a>
                <ul class="menu-submenu">
                    <li><a href="fd-calculator.html">FD Calculator</a></li>
                    <li><a href="rd-calculator.html">RD Calculator</a></li>
                    <li><a href="ppf-calculator.html">PPF Calculator</a></li>
                    <li><a href="epf-calculator.html">EPF Calculator</a></li>
                    <li><a href="ssy-calculator.html">SSY Calculator</a></li>
                </ul>
            </li>
            <li class="menu-dropdown">
                <a href="javascript:void(0)" class="menu-dropdown-toggle" onclick="return false;">Tax & Trading <span class="dropdown-arrow">â–¼</span></a>
                <ul class="menu-submenu">
                    <li><a href="income-tax-calculator.html">Income Tax Calculator</a></li>
                    <li><a href="hra-calculator.html">HRA Calculator</a></li>
                    <li><a href="salary-calculator.html">Salary Calculator</a></li>
                    <li><a href="tds-calculator.html">TDS Calculator</a></li>
                    <li><a href="gst-calculator.html">GST Calculator</a></li>
                    <li><a href="brokerage-calculator.html">Brokerage Calculator</a></li>
                    <li><a href="margin-calculator.html">Margin Calculator</a></li>
                    <li class="active"><a href="stock-average-calculator.html">Stock Average Calculator</a></li>
                </ul>
            </li>
            <li><a href="repo-rates.html">Repo Rates</a></li>
            <li><a href="privacy-policy.html">Privacy Policy</a></li>
        </ul>
    </nav>

    <main class="calculator-container">
        <h1>Stock Average Calculator</h1>
        <p>Calculate average stock price for multiple purchases and analyze your averaging down strategy with breakeven projections.</p>
        
        <div class="calc-grid">
            <div class="inputs-section">
                <div class="input-group">
                    <label class="input-label" for="currentPrice">Current Market Price (â‚¹)</label>
                    <input type="text" id="currentPrice" class="input-field" value="1,200" placeholder="Enter current price">
                </div>
                
                <div id="transactionsContainer">
                    <div class="transaction-entry" data-transaction="1">
                        <div class="transaction-header">
                            <span class="transaction-number">Purchase 1</span>
                        </div>
                        <div class="transaction-grid">
                            <div class="input-group">
                                <label class="input-label">Quantity</label>
                                <input type="number" class="quantity-input input-field" value="100" min="1" step="1">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Price (â‚¹)</label>
                                <input type="text" class="price-input input-field" value="1,500" placeholder="Purchase price">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="addTransaction()" class="add-btn">Add Another Purchase</button>
                <button onclick="calculateAverage()" class="calc-btn">Calculate Average</button>
                <button onclick="printResults()" class="print-btn">Print Results</button>
                
                <div class="strategy-tips">
                    <h4>ðŸ’¡ Averaging Down Tips</h4>
                    <ul>
                        <li>Only average down on fundamentally strong stocks</li>
                        <li>Set a maximum limit on total investment</li>
                        <li>Avoid averaging down on speculative stocks</li>
                        <li>Consider the overall market trend</li>
                        <li>Have a clear exit strategy</li>
                    </ul>
                </div>
            </div>
            
            <div class="results-section">
                <div class="results-panel">
                    <h3 style="margin-top: 0; margin-bottom: 25px;">Portfolio Summary</h3>
                    
                    <div class="result-item">
                        <span class="result-label">Total Quantity:</span>
                        <span class="result-value" id="totalQuantity">100 shares</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Total Investment:</span>
                        <span class="result-value" id="totalInvestment">â‚¹1,50,000</span>
                    </div>
                    
                    <div class="result-item highlight">
                        <span class="result-label">Average Price:</span>
                        <span class="result-value" id="averagePrice">â‚¹1,500</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Current Value:</span>
                        <span class="result-value" id="currentValue">â‚¹1,20,000</span>
                    </div>
                    
                    <div class="result-item">
                        <span class="result-label">Unrealized P&L:</span>
                        <span class="result-value" id="unrealizedPL">-â‚¹30,000</span>
                    </div>
                    
                    <div class="result-item" style="border-bottom: none;">
                        <span class="result-label">P&L Percentage:</span>
                        <span class="result-value" id="plPercentage">-20.0%</span>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="portfolioChart" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <div class="analysis-panel">
                    <h4>Breakeven Analysis</h4>
                    <div class="breakeven-info">
                        <div class="breakeven-item">
                            <div class="breakeven-value" id="breakevenPrice">â‚¹1,500</div>
                            <div class="breakeven-label">Breakeven Price</div>
                        </div>
                        <div class="breakeven-item" id="breakevenMove">
                            <div class="breakeven-value" id="breakevenMoveValue">+25.0%</div>
                            <div class="breakeven-label">Required Move</div>
                        </div>
                    </div>
                    
                    <div class="scenario-analysis">
                        <h4>Price Scenario Analysis</h4>
                        <div class="scenario-grid" id="scenarioGrid">
                            <!-- Scenarios will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="transactions-table">
                    <h4>Transaction History</h4>
                    <div class="table-body">
                        <table class="trans-table">
                            <thead>
                                <tr>
                                    <th>Purchase</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th class="amount">Amount</th>
                                    <th class="amount">Weight</th>
                                </tr>
                            </thead>
                            <tbody id="transactionTableBody">
                                <!-- Transaction rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Skrollmates.com</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="menu.js" defer></script>
    <script>
        let chartInstance = null;
        let transactionCount = 1;
        
        // Indian rupee formatter
        function formatIndianRupee(amount) {
            return 'â‚¹' + Math.round(amount).toLocaleString('en-IN');
        }
        
        // Format input fields with commas
        function formatNumberInput(input) {
            // Add keydown event to prevent non-numeric characters
            input.addEventListener('keydown', function(e) {
                // Allow: backspace, delete, tab, escape, enter
                if ([8, 9, 27, 13, 46].indexOf(e.keyCode) !== -1 ||
                    // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+Z
                    (e.keyCode === 65 && e.ctrlKey === true) ||
                    (e.keyCode === 67 && e.ctrlKey === true) ||
                    (e.keyCode === 86 && e.ctrlKey === true) ||
                    (e.keyCode === 88 && e.ctrlKey === true) ||
                    (e.keyCode === 90 && e.ctrlKey === true) ||
                    // Allow: home, end, left, right, up, down
                    (e.keyCode >= 35 && e.keyCode <= 40)) {
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                    e.preventDefault();
                }
            });
            
            let value = input.value.replace(/[^\d]/g, '');
            if (value) {
                input.value = parseInt(value).toLocaleString('en-IN');
            }
        }
        
        // Parse Indian formatted number
        function parseIndianNumber(str) {
            return parseFloat(str.replace(/[â‚¹,]/g, '')) || 0;
        }
        
        function addTransaction() {
            transactionCount++;
            const container = document.getElementById('transactionsContainer');
            
            const transactionHTML = `
                <div class="transaction-entry" data-transaction="${transactionCount}">
                    <div class="transaction-header">
                        <span class="transaction-number">Purchase ${transactionCount}</span>
                        <button class="remove-btn" onclick="removeTransaction(${transactionCount})" title="Remove this purchase">Ã—</button>
                    </div>
                    <div class="transaction-grid">
                        <div class="input-group">
                            <label class="input-label">Quantity</label>
                            <input type="number" class="quantity-input input-field" value="50" min="1" step="1">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Price (â‚¹)</label>
                            <input type="text" class="price-input input-field" value="1,300" placeholder="Purchase price">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', transactionHTML);
            
            // Add event listeners to new inputs
            const newTransaction = container.lastElementChild;
            const priceInput = newTransaction.querySelector('.price-input');
            const quantityInput = newTransaction.querySelector('.quantity-input');
            
            priceInput.addEventListener('input', function() {
                formatNumberInput(this);
                calculateAverage();
            });
            priceInput.addEventListener('blur', function() {
                formatNumberInput(this);
                calculateAverage();
            });
            
            quantityInput.addEventListener('input', calculateAverage);
            quantityInput.addEventListener('change', calculateAverage);
            
            calculateAverage();
        }
        
        function removeTransaction(transactionId) {
            const transaction = document.querySelector(`[data-transaction="${transactionId}"]`);
            if (transaction && document.querySelectorAll('.transaction-entry').length > 1) {
                transaction.remove();
                calculateAverage();
            }
        }
        
        function calculateAverage() {
            const currentPrice = parseIndianNumber(document.getElementById('currentPrice').value) || 0;
            const transactions = [];
            
            // Collect all transactions
            document.querySelectorAll('.transaction-entry').forEach((entry, index) => {
                const quantity = parseInt(entry.querySelector('.quantity-input').value) || 0;
                const price = parseIndianNumber(entry.querySelector('.price-input').value) || 0;
                
                if (quantity > 0 && price > 0) {
                    transactions.push({
                        index: index + 1,
                        quantity: quantity,
                        price: price,
                        amount: quantity * price
                    });
                }
            });
            
            if (transactions.length === 0) return;
            
            // Calculate totals
            const totalQuantity = transactions.reduce((sum, t) => sum + t.quantity, 0);
            const totalInvestment = transactions.reduce((sum, t) => sum + t.amount, 0);
            const averagePrice = totalInvestment / totalQuantity;
            const currentValue = totalQuantity * currentPrice;
            const unrealizedPL = currentValue - totalInvestment;
            const plPercentage = (unrealizedPL / totalInvestment) * 100;
            
            // Update display
            document.getElementById('totalQuantity').textContent = totalQuantity.toLocaleString('en-IN') + ' shares';
            document.getElementById('totalInvestment').textContent = formatIndianRupee(totalInvestment);
            document.getElementById('averagePrice').textContent = formatIndianRupee(averagePrice);
            document.getElementById('currentValue').textContent = formatIndianRupee(currentValue);
            document.getElementById('unrealizedPL').textContent = (unrealizedPL >= 0 ? '+' : '') + formatIndianRupee(unrealizedPL);
            document.getElementById('plPercentage').textContent = (plPercentage >= 0 ? '+' : '') + plPercentage.toFixed(1) + '%';
            
            // Update color coding
            const plElements = [document.getElementById('unrealizedPL'), document.getElementById('plPercentage')];
            plElements.forEach(element => {
                element.style.color = unrealizedPL >= 0 ? '#4caf50' : '#f44336';
            });
            
            // Breakeven analysis
            const breakevenPrice = averagePrice;
            const breakevenMove = ((breakevenPrice - currentPrice) / currentPrice) * 100;
            
            document.getElementById('breakevenPrice').textContent = formatIndianRupee(breakevenPrice);
            document.getElementById('breakevenMoveValue').textContent = (breakevenMove >= 0 ? '+' : '') + breakevenMove.toFixed(1) + '%';
            
            // Update breakeven styling
            const breakevenItem = document.getElementById('breakevenMove');
            const breakevenValue = document.getElementById('breakevenMoveValue');
            if (breakevenMove > 0) {
                breakevenItem.classList.add('negative');
                breakevenValue.classList.add('negative');
            } else {
                breakevenItem.classList.remove('negative');
                breakevenValue.classList.remove('negative');
            }
            
            // Update transaction table
            updateTransactionTable(transactions);
            
            // Update scenario analysis
            updateScenarioAnalysis(averagePrice, totalQuantity, totalInvestment);
            
            // Update chart
            updateChart(transactions, currentPrice, averagePrice);
        }
        
        function updateTransactionTable(transactions) {
            const tbody = document.getElementById('transactionTableBody');
            const totalInvestment = transactions.reduce((sum, t) => sum + t.amount, 0);
            
            tbody.innerHTML = transactions.map(t => {
                const weight = (t.amount / totalInvestment * 100).toFixed(1);
                return `
                    <tr>
                        <td>Purchase ${t.index}</td>
                        <td>${t.quantity.toLocaleString('en-IN')}</td>
                        <td>${formatIndianRupee(t.price)}</td>
                        <td class="amount">${formatIndianRupee(t.amount)}</td>
                        <td class="amount">${weight}%</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateScenarioAnalysis(averagePrice, totalQuantity, totalInvestment) {
            const scenarios = [
                { label: '-20%', multiplier: 0.8 },
                { label: '-10%', multiplier: 0.9 },
                { label: 'Breakeven', multiplier: 1.0 },
                { label: '+10%', multiplier: 1.1 },
                { label: '+20%', multiplier: 1.2 }
            ];
            
            const scenarioGrid = document.getElementById('scenarioGrid');
            scenarioGrid.innerHTML = scenarios.map(scenario => {
                const price = averagePrice * scenario.multiplier;
                const value = totalQuantity * price;
                const pl = value - totalInvestment;
                const plClass = pl >= 0 ? 'profit' : 'loss';
                
                return `
                    <div class="scenario-item">
                        <div class="scenario-price">${formatIndianRupee(price)}</div>
                        <div class="scenario-pl ${plClass}">${(pl >= 0 ? '+' : '')}${formatIndianRupee(pl)}</div>
                        <div class="breakeven-label">${scenario.label}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateChart(transactions, currentPrice, averagePrice) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const labels = transactions.map((t, index) => `Purchase ${index + 1}`);
            const purchasePrices = transactions.map(t => t.price);
            
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Purchase Price',
                        data: purchasePrices,
                        borderColor: '#2e7d32',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Average Price',
                        data: new Array(transactions.length).fill(averagePrice),
                        borderColor: '#ff9800',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }, {
                        label: 'Current Price',
                        data: new Array(transactions.length).fill(currentPrice),
                        borderColor: '#f44336',
                        borderDash: [10, 5],
                        borderWidth: 2,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#333',
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y || 0;
                                    return `${label}: ${formatIndianRupee(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: function(value) {
                                    return formatIndianRupee(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function printResults() {
            window.print();
        }
        
        // Add event listeners for input formatting
        document.addEventListener('DOMContentLoaded', function() {
            // Format current price input
            const currentPriceInput = document.getElementById('currentPrice');
            currentPriceInput.addEventListener('input', function() {
                formatNumberInput(this);
                calculateAverage();
            });
            currentPriceInput.addEventListener('blur', function() {
                formatNumberInput(this);
                calculateAverage();
            });
            
            // Format existing transaction inputs
            document.querySelectorAll('.price-input').forEach(input => {
                input.addEventListener('input', function() {
                    formatNumberInput(this);
                    calculateAverage();
                });
                input.addEventListener('blur', function() {
                    formatNumberInput(this);
                    calculateAverage();
                });
            });
            
            document.querySelectorAll('.quantity-input').forEach(input => {
                input.addEventListener('input', calculateAverage);
                input.addEventListener('change', calculateAverage);
            });
            
            calculateAverage();
        });
    </script>
</body>
</html>